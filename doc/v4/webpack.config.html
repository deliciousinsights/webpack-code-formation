<!DOCTYPE html><html lang="en"><head><title>v4/webpack.config</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="v4/webpack.config"><meta name="groc-project-path" content="v4/webpack.config.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">v4/webpack.config.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="webpack-v4-configuration-principale">Webpack v4 - Configuration principale</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> merge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-merge'</span>)
<span class="hljs-keyword">const</span> parts = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./webpack.config.parts'</span>)
<span class="hljs-keyword">const</span> Path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="chemins-principaux">Chemins principaux</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> PATHS = {
  build: Path.resolve(__dirname, <span class="hljs-string">'dist'</span>),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Les entries peuvent être relatives, mais au CWD, alors autant forcer
l’absolu par rapport au fichier de config.</p></div></div><div class="code"><div class="wrapper">  source: Path.resolve(__dirname, <span class="hljs-string">'src'</span>),
  static: Path.resolve(__dirname, <span class="hljs-string">'static'</span>),
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="config-partage-devprod">Config partagée dev/prod</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> coreConfig = merge(
  {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Point d’entrée de l’application. En utilisant un objet, on facilite
l’extraction d’autres entrées auto (type vendor).</p></div></div><div class="code"><div class="wrapper">    entry: { main: [PATHS.source] },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sortie produite par le build.</p></div></div><div class="code"><div class="wrapper">    output: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Format des URLs de fichiers d’origine dans les source maps.  On vire le
<code>?query</code> par défaut, qui est moche et ne sert à rien</p></div></div><div class="code"><div class="wrapper">      devtoolModuleFilenameTemplate: <span class="hljs-string">'webpack:///[resource-path]'</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Schéma des noms de fichiers bundles. Le <code>[name]</code> sera remplacé par le
nom du bundle, basé sur celui de l’entrée (ex. <code>main</code>). Ce nom peut
contenir des chemins au début, le tout relatif à <code>output.path</code>.</p></div></div><div class="code"><div class="wrapper">      filename: <span class="hljs-string">'[name].js'</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Chemin absolu racine de production des fichiers bundlés.</p></div></div><div class="code"><div class="wrapper">      path: PATHS.build,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Préfixe de chemin des URLs pour les fichiers produits.  Ici, on est
« racine domaine », mais si on prévoit un déploiement (dev ou prod)
dans un sous-chemin, il est impératif de le caler ici.</p></div></div><div class="code"><div class="wrapper">      publicPath: <span class="hljs-string">'/'</span>,
    },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cette nouvelle série d’options de Webpack 4 remplace pas mal d’anciennes
manips, notamment tout ce qui touche à <code>CommonsChunkPlugin</code>.</p></div></div><div class="code"><div class="wrapper">    optimization: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Extraction à part de la <em>runtime</em> Webpack</p></div></div><div class="code"><div class="wrapper">      runtimeChunk: <span class="hljs-literal">true</span>,
      splitChunks: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Auto-splitting intelligent de tous les chunks (initiaux et
asynchrones) (par défaut, ça ne fait que les asynchrones).</p></div></div><div class="code"><div class="wrapper">        chunks: <span class="hljs-string">'all'</span>,
      },
    },
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On utilise des source maps ; par défaut ici, on sera en <code>eval-source-map</code>,
qui a ceci de mieux que le <code>eval</code> de base qu’il utilise le source
d’origine, pas le transpilé / transformé.</p></div></div><div class="code"><div class="wrapper">  parts.generateSourceMaps(),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Passage des JS/JSX à travers Babel, par défaut en <code>preset-env</code> sans
transpilation de modules, pour que Webpack puisse faire ses optims majeures
(<em>tree shaking</em>, <em>scope hoisting</em>).  On limite à nos propres sources, pour
aller plus vite</p></div></div><div class="code"><div class="wrapper">  parts.babelize({ include: PATHS.source }),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Annulation du bundling par défaut de tous les locales Moment en raison du
require dynamique (<code>require(&#39;./locale/&#39; + locale)</code>) dans son code source.
On s’économise bien 50Ko min+gz.</p></div></div><div class="code"><div class="wrapper">  parts.ignoreMomentLocales(),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ESLint sur nos propres JS, intégré au build : ça remontera notamment dans
l’overlay.</p></div></div><div class="code"><div class="wrapper">  parts.lintJS({ include: PATHS.source }),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Copie récursivement le(s) répertoire(s) passé(s) dans le dossier de
destination.</p></div></div><div class="code"><div class="wrapper">  parts.copyStatic(PATHS.static),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Prise en compte des assets images, avec inlining auto si inférieures à
10Ko.</p></div></div><div class="code"><div class="wrapper">  parts.loadImages(),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Prise en compte des assets webfonts, avec inlining auto si inférieures à
10Ko.</p></div></div><div class="code"><div class="wrapper">  parts.loadFonts(),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Génération et maintenance auto du <code>index.html</code>, avec les bonnes balises
<code>&lt;script&gt;</code> et <code>&lt;link rel=&quot;styleheet&quot;/&gt;</code></p></div></div><div class="code"><div class="wrapper">  parts.html({ title: <span class="hljs-string">'Webpack 4 - Premiers Pas'</span>, inlineRuntime: <span class="hljs-literal">true</span> }),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pas de production de fichiers à jour si 1+ asset a un problème</p></div></div><div class="code"><div class="wrapper">  parts.safeAssets()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A des soucis au premier build de nouveau cache sur WP4 récents…
(<a href="https://github.com/mzgoddard/hard-source-webpack-plugin/issues/526">https://github.com/mzgoddard/hard-source-webpack-plugin/issues/526</a>)
parts.useModuleLevelCache()</p></div></div><div class="code"><div class="wrapper">)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="config-complmentaire-de-dev">Config complémentaire de dev</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> devConfig = () =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le <code>merge.smart</code> devrait en fait être le mode par défaut : il fusionne
intelligemment les pipelines de loaders, à clé (ex. <code>test</code>) égale.</p></div></div><div class="code"><div class="wrapper">  merge.smart(
    coreConfig,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Mode explicite, qui nous évite de devoir le préciser dans la CLI</p></div></div><div class="code"><div class="wrapper">    { mode: <span class="hljs-string">'development'</span> },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Personnalisation du Webpack-Dev-Server lancé en dev…</p></div></div><div class="code"><div class="wrapper">    parts.devServer({</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>…port personnalisé (par défaut 8080)</p></div></div><div class="code"><div class="wrapper">      port: <span class="hljs-number">3004</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>…démo proxy (pour avoir un seul port frontal en dépit de couches
backend distinctes qui produisent le HTML, les réponses API, etc.).</p></div></div><div class="code"><div class="wrapper">      proxy: {
        <span class="hljs-string">'/api'</span>: {
          target: <span class="hljs-string">'https://jsonplaceholder.typicode.com'</span>,
          pathRewrite: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> },
          changeOrigin: <span class="hljs-literal">true</span>,
        },
      },
    }),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Overlay haut de gamme pour erreurs d&#39;exécution dans le browser</p></div></div><div class="code"><div class="wrapper">    parts.errorOverlay(),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Webpack-Dashboard ; sympa pour superviser le build et ses contenus</p></div></div><div class="code"><div class="wrapper">    parts.dashboard(),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Chargement à la volée des CSS ; PostCSS+cssnext est là de base, et on
active les CSS Modules au niveau du <code>css-loader</code>.</p></div></div><div class="code"><div class="wrapper">    parts.loadCSS({ modules: <span class="hljs-literal">true</span> }),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Idem, mais avec la transpilation SASS en début de pipeline (SASS3 :
extension <code>.scss</code>).</p></div></div><div class="code"><div class="wrapper">    parts.loadSASS({ modules: <span class="hljs-literal">true</span> })
  )</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="config-complmentaire-de-prod">Config complémentaire de prod</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> prodConfig = () =&gt;
  merge.smart(</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Nettoyage du dossier cible (<code>dist/</code>), vu qu’avec les hashes dans les noms
de fichiers, ceux-ci vont potentiellement changer d’un build à l’autre.</p></div></div><div class="code"><div class="wrapper">    parts.cleanDist(),
    coreConfig,
    {
      mode: <span class="hljs-string">'production'</span>,
      output: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On ajoute un hash court (basé MD5 par défaut) aux noms de fichiers
pour améliorer leur mise en cache (<em>Long-Term Caching</em>) au moyen
d’expirations très longues.</p></div></div><div class="code"><div class="wrapper">        filename: <span class="hljs-string">'[name].[chunkhash:8].js'</span>,
      },
      stats: { optimizationBailout: <span class="hljs-literal">true</span> },
    },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Changement du type de source maps pour les mettre dans des fichiers à
part, et avec le plus fort niveau de détail possible.</p></div></div><div class="code"><div class="wrapper">    parts.generateSourceMaps({ type: <span class="hljs-string">'source-map'</span> }),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Extraction dans des fichiers à part des CSS, d’où qu’elles viennent.</p></div></div><div class="code"><div class="wrapper">    parts.extractCSS({ modules: <span class="hljs-literal">true</span> }),
    parts.extractSASS({ modules: <span class="hljs-literal">true</span> }),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Minification du JS et des CSS</p></div></div><div class="code"><div class="wrapper">    parts.minifyAll(),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Optimisation des images (utilise <code>imagemin</code> en interne, opère aussi bien
sur les JPEG que sur les PNG, GIF, WEBP et SVG).</p></div></div><div class="code"><div class="wrapper">    parts.optimizeImages(),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pré-compression (<code>.gz</code> basée Zopfli) des fichiers textuels (HTML, CSS,
JS, SVG) et des PNG (basée Zopfli, sans extension complémentaire).</p></div></div><div class="code"><div class="wrapper">    parts.compressFiles(),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Publier le manifeste des assets et de leurs versions « fingerprintées »,
pour exploitation potentielle par de la génération tierce de HTML.</p></div></div><div class="code"><div class="wrapper">    parts.publishManifest()
  )</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On exporte une fonction : elle recevra en argument la valeur composée à
partir des arguments <code>--env</code> de la CLI ; on n’en passe pas, donc à défaut
elle prend le <code>process.env.NODE_ENV</code> en vigueur et renvoie la config
appropriée.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">module</span>.exports = (env = process.env.NODE_ENV) =&gt;
  env === <span class="hljs-string">'production'</span> ? prodConfig() : devConfig()</div></div></div></div></body></html>